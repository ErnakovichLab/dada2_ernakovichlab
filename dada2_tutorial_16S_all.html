<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<style type="text/css">
@font-face {
font-family: octicons-link;
src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format('woff');
}
body {
-webkit-text-size-adjust: 100%;
text-size-adjust: 100%;
color: #333;
font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
font-size: 16px;
line-height: 1.6;
word-wrap: break-word;
}
a {
background-color: transparent;
}
a:active,
a:hover {
outline: 0;
}
strong {
font-weight: bold;
}
h1 {
font-size: 2em;
margin: 0.67em 0;
}
img {
border: 0;
}
hr {
box-sizing: content-box;
height: 0;
}
pre {
overflow: auto;
}
code,
kbd,
pre {
font-family: monospace, monospace;
font-size: 1em;
}
input {
color: inherit;
font: inherit;
margin: 0;
}
html input[disabled] {
cursor: default;
}
input {
line-height: normal;
}
input[type="checkbox"] {
box-sizing: border-box;
padding: 0;
}
table {
border-collapse: collapse;
border-spacing: 0;
}
td,
th {
padding: 0;
}
* {
box-sizing: border-box;
}
input {
font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}
a {
color: #4078c0;
text-decoration: none;
}
a:hover,
a:active {
text-decoration: underline;
}
hr {
height: 0;
margin: 15px 0;
overflow: hidden;
background: transparent;
border: 0;
border-bottom: 1px solid #ddd;
}
hr:before {
display: table;
content: "";
}
hr:after {
display: table;
clear: both;
content: "";
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 15px;
margin-bottom: 15px;
line-height: 1.1;
}
h1 {
font-size: 30px;
}
h2 {
font-size: 21px;
}
h3 {
font-size: 16px;
}
h4 {
font-size: 14px;
}
h5 {
font-size: 12px;
}
h6 {
font-size: 11px;
}
blockquote {
margin: 0;
}
ul,
ol {
padding: 0;
margin-top: 0;
margin-bottom: 0;
}
ol ol,
ul ol {
list-style-type: lower-roman;
}
ul ul ol,
ul ol ol,
ol ul ol,
ol ol ol {
list-style-type: lower-alpha;
}
dd {
margin-left: 0;
}
code {
font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
font-size: 12px;
}
pre {
margin-top: 0;
margin-bottom: 0;
font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}
.select::-ms-expand {
opacity: 0;
}
.octicon {
font: normal normal normal 16px/1 octicons-link;
display: inline-block;
text-decoration: none;
text-rendering: auto;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
.octicon-link:before {
content: '\f05c';
}
.markdown-body:before {
display: table;
content: "";
}
.markdown-body:after {
display: table;
clear: both;
content: "";
}
.markdown-body>*:first-child {
margin-top: 0 !important;
}
.markdown-body>*:last-child {
margin-bottom: 0 !important;
}
a:not([href]) {
color: inherit;
text-decoration: none;
}
.anchor {
display: inline-block;
padding-right: 2px;
margin-left: -18px;
}
.anchor:focus {
outline: none;
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 1em;
margin-bottom: 16px;
font-weight: bold;
line-height: 1.4;
}
h1 .octicon-link,
h2 .octicon-link,
h3 .octicon-link,
h4 .octicon-link,
h5 .octicon-link,
h6 .octicon-link {
color: #000;
vertical-align: middle;
visibility: hidden;
}
h1:hover .anchor,
h2:hover .anchor,
h3:hover .anchor,
h4:hover .anchor,
h5:hover .anchor,
h6:hover .anchor {
text-decoration: none;
}
h1:hover .anchor .octicon-link,
h2:hover .anchor .octicon-link,
h3:hover .anchor .octicon-link,
h4:hover .anchor .octicon-link,
h5:hover .anchor .octicon-link,
h6:hover .anchor .octicon-link {
visibility: visible;
}
h1 {
padding-bottom: 0.3em;
font-size: 2.25em;
line-height: 1.2;
border-bottom: 1px solid #eee;
}
h1 .anchor {
line-height: 1;
}
h2 {
padding-bottom: 0.3em;
font-size: 1.75em;
line-height: 1.225;
border-bottom: 1px solid #eee;
}
h2 .anchor {
line-height: 1;
}
h3 {
font-size: 1.5em;
line-height: 1.43;
}
h3 .anchor {
line-height: 1.2;
}
h4 {
font-size: 1.25em;
}
h4 .anchor {
line-height: 1.2;
}
h5 {
font-size: 1em;
}
h5 .anchor {
line-height: 1.1;
}
h6 {
font-size: 1em;
color: #777;
}
h6 .anchor {
line-height: 1.1;
}
p,
blockquote,
ul,
ol,
dl,
table,
pre {
margin-top: 0;
margin-bottom: 16px;
}
hr {
height: 4px;
padding: 0;
margin: 16px 0;
background-color: #e7e7e7;
border: 0 none;
}
ul,
ol {
padding-left: 2em;
}
ul ul,
ul ol,
ol ol,
ol ul {
margin-top: 0;
margin-bottom: 0;
}
li>p {
margin-top: 16px;
}
dl {
padding: 0;
}
dl dt {
padding: 0;
margin-top: 16px;
font-size: 1em;
font-style: italic;
font-weight: bold;
}
dl dd {
padding: 0 16px;
margin-bottom: 16px;
}
blockquote {
padding: 0 15px;
color: #777;
border-left: 4px solid #ddd;
}
blockquote>:first-child {
margin-top: 0;
}
blockquote>:last-child {
margin-bottom: 0;
}
table {
display: block;
width: 100%;
overflow: auto;
word-break: normal;
word-break: keep-all;
}
table th {
font-weight: bold;
}
table th,
table td {
padding: 6px 13px;
border: 1px solid #ddd;
}
table tr {
background-color: #fff;
border-top: 1px solid #ccc;
}
table tr:nth-child(2n) {
background-color: #f8f8f8;
}
img {
max-width: 100%;
box-sizing: content-box;
background-color: #fff;
}
code {
padding: 0;
padding-top: 0.2em;
padding-bottom: 0.2em;
margin: 0;
font-size: 85%;
background-color: rgba(0,0,0,0.04);
border-radius: 3px;
}
code:before,
code:after {
letter-spacing: -0.2em;
content: "\00a0";
}
pre>code {
padding: 0;
margin: 0;
font-size: 100%;
word-break: normal;
white-space: pre;
background: transparent;
border: 0;
}
.highlight {
margin-bottom: 16px;
}
.highlight pre,
pre {
padding: 16px;
overflow: auto;
font-size: 85%;
line-height: 1.45;
background-color: #f7f7f7;
border-radius: 3px;
}
.highlight pre {
margin-bottom: 0;
word-break: normal;
}
pre {
word-wrap: normal;
}
pre code {
display: inline;
max-width: initial;
padding: 0;
margin: 0;
overflow: initial;
line-height: inherit;
word-wrap: normal;
background-color: transparent;
border: 0;
}
pre code:before,
pre code:after {
content: normal;
}
kbd {
display: inline-block;
padding: 3px 5px;
font-size: 11px;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.pl-c {
color: #969896;
}
.pl-c1,
.pl-s .pl-v {
color: #0086b3;
}
.pl-e,
.pl-en {
color: #795da3;
}
.pl-s .pl-s1,
.pl-smi {
color: #333;
}
.pl-ent {
color: #63a35c;
}
.pl-k {
color: #a71d5d;
}
.pl-pds,
.pl-s,
.pl-s .pl-pse .pl-s1,
.pl-sr,
.pl-sr .pl-cce,
.pl-sr .pl-sra,
.pl-sr .pl-sre {
color: #183691;
}
.pl-v {
color: #ed6a43;
}
.pl-id {
color: #b52a1d;
}
.pl-ii {
background-color: #b52a1d;
color: #f8f8f8;
}
.pl-sr .pl-cce {
color: #63a35c;
font-weight: bold;
}
.pl-ml {
color: #693a17;
}
.pl-mh,
.pl-mh .pl-en,
.pl-ms {
color: #1d3e81;
font-weight: bold;
}
.pl-mq {
color: #008080;
}
.pl-mi {
color: #333;
font-style: italic;
}
.pl-mb {
color: #333;
font-weight: bold;
}
.pl-md {
background-color: #ffecec;
color: #bd2c00;
}
.pl-mi1 {
background-color: #eaffea;
color: #55a532;
}
.pl-mdr {
color: #795da3;
font-weight: bold;
}
.pl-mo {
color: #1d3e81;
}
kbd {
display: inline-block;
padding: 3px 5px;
font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.task-list-item {
list-style-type: none;
}
.task-list-item+.task-list-item {
margin-top: 3px;
}
.task-list-item input {
margin: 0 0.35em 0.25em -1.6em;
vertical-align: middle;
}
:checked+.radio-label {
z-index: 1;
position: relative;
border-color: #4078c0;
}
.sourceLine {
display: inline-block;
}
code .kw { color: #000000; }
code .dt { color: #ed6a43; }
code .dv { color: #009999; }
code .bn { color: #009999; }
code .fl { color: #009999; }
code .ch { color: #009999; }
code .st { color: #183691; }
code .co { color: #969896; }
code .ot { color: #0086b3; }
code .al { color: #a61717; }
code .fu { color: #63a35c; }
code .er { color: #a61717; background-color: #e3d2d2; }
code .wa { color: #000000; }
code .cn { color: #008080; }
code .sc { color: #008080; }
code .vs { color: #183691; }
code .ss { color: #183691; }
code .im { color: #000000; }
code .va {color: #008080; }
code .cf { color: #000000; }
code .op { color: #000000; }
code .bu { color: #000000; }
code .ex { color: #000000; }
code .pp { color: #999999; }
code .at { color: #008080; }
code .do { color: #969896; }
code .an { color: #008080; }
code .cv { color: #008080; }
code .in { color: #008080; }
</style>
<style>
body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 45px;
  padding-top: 0px;
}
</style>

</head>

<body>

<h1 id="dada2-tutorial-with-novaseq-dataset-for-ernakovich-lab">dada2 tutorial with NovaSeq dataset for Ernakovich Lab</h1>
<p><em>This tutorial originally created by Angela Oliverio and Hannah Holland-Moritz. It has been updated for the Ernakovich Lab. Other contributors to this pipeline include: Corinne Walsh, Matt Gebert, and Kunkun Fan</em><br />
<em>Updated October 28, 2021</em></p>
<p>This pipeline runs the dada2 workflow for Big Data (paired-end) with modifications for NovaSeq sequencing base calls</p>
<p>We suggest opening the dada2 tutorial online to understand more about each step. The original pipeline on which this tutorial is based can be found here: <a href="https://benjjneb.github.io/dada2/bigdata_paired.html">https://benjjneb.github.io/dada2/bigdata_paired.html</a></p>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>NOTE:</strong> There is a slightly different pipeline for ITS and non-“Big data” workflows. The non-“Big data” pipeline, in particular, has very nice detailed explanations for each step and can be found here: <a href="https://benjjneb.github.io/dada2/tutorial.html">https://benjjneb.github.io/dada2/tutorial.html</a></td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h2 id="preliminary-checklist-part-0---before-you-begin">Preliminary Checklist (part 0) - Before You Begin</h2>
<ol style="list-style-type: decimal">
<li><p>Check to make sure you know what your target ‘AMPLICON’ length. This can vary between primer sets, as well as WITHIN primer sets. For example, ITS (internal transcribed spacer) amplicon can vary from ~100 bps to 300 bps</p>
<p>For examples regarding commonly used primer sets (515f/806r, Fungal ITS2, 1391f/EukBr) see protocols on the Earth Microbiome Project website: <a href="http://press.igsb.anl.gov/earthmicrobiome/protocols-and-standards/">http://press.igsb.anl.gov/earthmicrobiome/protocols-and-standards/</a></p></li>
<li><p>Check to make sure you know how long your reads should be (i.e., how long should the reads be coming off the sequencer?) This is not the same as fragment length, as many times, especially with longer fragments, the entire fragment is not being sequenced in one direction. When long <em>amplicons</em> are not sequenced with a <em>read length</em> that allows for substantial overlap between the forward and reverse read, you can potentially insert biases into the data. If you intend to merge your paired end reads, ensure that your read length is appropriate. For example, with a MiSeq 2 x 150, 300 cycle kit, you will get bidirectional reads of 150 base pairs.</p></li>
<li><p>Make note of which sequencing platform was used, as this can impact both read quality and downstream analysis. In particular, this pipeline is designed to process NovaSeq data which has very different quality scores than HiSeq or MiSeq data.</p></li>
<li><p>Decide which database is best suited for your analysis needs. Note that DADA2 requires databases be in a custom format! If a custom database is required, further formatting will be needed to ensure that it can run correctly in dada2.</p>
<p>See the following link for details regarding database formatting: <a href="https://benjjneb.github.io/dada2/training.html#formatting-custom-databases">https://benjjneb.github.io/dada2/training.html#formatting-custom-databases</a></p></li>
<li><p>For additional tutorials and reporting issues, please see link below:<br />
dada2 tutorial: <a href="https://benjjneb.github.io/dada2/tutorial.html">https://benjjneb.github.io/dada2/tutorial.html</a><br />
dada2 pipeline issues*: <a href="https://github.com/fiererlab/dada2_fiererlab/issues">https://github.com/fiererlab/dada2_fiererlab/issues</a></p>
<p>*Note by default, only ‘OPEN’ issues are shown. You can look at all issues by removing “is:open” in the search bar at the top.</p></li>
</ol>
<h2 id="set-up-part-1---steps-before-starting-pipeline">Set up (part 1) - Steps before starting pipeline</h2>
<h4 id="downloading-this-tutorial-from-github">Downloading this tutorial from github</h4>
<p>Once you have logged in, you can download a copy of the tutorial into your directory on the server. To retrieve the folder with this tutorial from github directly to the server, type the following into your terminal and hit return after each line.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/ernakovichlab/dada2_ernakovichlab/archive/main.zip</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span> main.zip</span></code></pre></div>
<p>If there are ever updates to the tutorial on github, you can update the contents of this folder by downloading the new version from the same link as above.</p>
<h4 id="setup-and-install-software-you-will-only-need-to-do-this-the-first-time-or-if-you-want-to-update-dada2">Setup and install software (you will only need to do this the first time, or if you want to update dada2)</h4>
<ol style="list-style-type: decimal">
<li>Install the conda environment (this will install all the necessary software to run dada2)</li>
<li>First start by cleaning up modules, and then loading the anaconda module.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> purge</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load anaconda/colsa</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Next create a conda local environment that you can use to run the software. This will install everything you need to run dada2.</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> dada2_ernakovichlab</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-f</span> dada2_ernakovich.yml</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate dada2_ernakovich</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>WARNING:</strong> This installation may take a long time, so only run this code if you have a fairly large chunk of time!</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>A note about running this on Premise:</strong> To run this on Premise, you will need to submit R-scripts to the job scheduler (slurm). The R scripts in this tutorial can be found in the “R” folder and have been carefully designed so that each step can be run with on slurm with minimal changes. The R scripts are numbered according to their steps. When you are called on to modify a particular step, use a terminal text editor (such as <code>nano</code>) to open up the appropriate R script and edit the code accordingly. For your convenience, there is also a folder called “slurm” which contains ready-made slurm scripts that you can use to submit each R script. The slurm scripts are designed to be submitted from the “slurm” folder. You can submit them by using <code>cd slurm</code> to navigate into the slurm folder, and <code>sbatch xxx_dada2_tutorial_16S.slurm</code> to submit each script. Throughout this pipeline you will see <strong>STOP</strong> notices. These indicate how you should modify the R script at each stage.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<p>If you are running it on your own computer (runs slower!):</p>
<ol style="list-style-type: decimal">
<li><p>Download this tutorial from github. Go to <a href="https://github.com/fiererlab/dada2_fiererlab/dada2_fiererlab">the homepage</a>, and click the green “Clone or download” button. Then click “Download ZIP”, to save it to your computer. Unzip the file to access the R-script.</p></li>
<li><p>Download the tutorial data from here <a href="http://cme.colorado.edu/projects/bioinformatics-tutorials">http://cme.colorado.edu/projects/bioinformatics-tutorials</a></p></li>
<li><p>Install cutadapt. If you are using conda, you may also use the .yml file to create an environment with cutadapt and all the necessary R packages pre-installed</p>
<ul>
<li>cutadapt can be installed from here: <a href="https://cutadapt.readthedocs.io/en/stable/installation.html">https://cutadapt.readthedocs.io/en/stable/installation.html</a></li>
</ul></li>
<li><p>Download the dada2-formatted reference database of your choice. Link to download here: <a href="https://benjjneb.github.io/dada2/training.html">https://benjjneb.github.io/dada2/training.html</a></p></li>
<li><p>Open the Rmarkdown script in Rstudio. The script is located in the tutorial folder you downloaded in the first step. You can navigate to the proper folder in Rstudio by clicking on the files tab and navigating to the location where you downloaded the github folder. Then click dada2_ernakovichlab and dada2_tutorial_16S_all.Rmd to open the script.</p></li>
</ol>
<p>Now, install DADA2 &amp; other necessary packages(if you haven’t opted for the conda option). Depending on how you set up Rstudio, you might get a prompt asking if you want to create your own library. Answer ‘yes’ twice in the console to continue.</p>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>WARNING:</strong> This installation may take a long time, so only run this code if these packages are not already installed!</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;BiocManager&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">&quot;dada2&quot;</span>, <span class="at">version =</span> <span class="st">&quot;3.8&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;https://bioconductor.org/biocLite.R&quot;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">biocLite</span>(<span class="st">&quot;ShortRead&quot;</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;dplyr&quot;</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidyr&quot;</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;Hmisc&quot;</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;plotly&quot;</span>)</span></code></pre></div>
<p>Once the packages are installed, you can check to make sure the auxiliary software is working and set up some of the variables that you will need along the way.</p>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>NOTE:</strong> If you are not working from premise, you will need to change the file paths for cutadapt to where they are stored on your computer/server.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<p>For this tutorial we will be working with some samples that we obtained 16S amplicon data for, from a Illumina Miseq run. The data for these samples can be found on the CME website. <a href="http://cme.colorado.edu/projects/bioinformatics-tutorials">http://cme.colorado.edu/projects/bioinformatics-tutorials</a></p>
<h2 id="set-up-part-2---you-are-logged-in-to-premise-or-have-rstudio-open-on-your-computer">Set up (part 2) - You are logged in to premise (or have Rstudio open on your computer)</h2>
<p>First load and test the installed packages to make sure they’re working</p>
<p>Load DADA2 and required packages</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dada2); <span class="fu">packageVersion</span>(<span class="st">&quot;dada2&quot;</span>) <span class="co"># the dada2 pipeline</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ShortRead); <span class="fu">packageVersion</span>(<span class="st">&quot;ShortRead&quot;</span>) <span class="co"># dada2 depends on this</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr); <span class="fu">packageVersion</span>(<span class="st">&quot;dplyr&quot;</span>) <span class="co"># for manipulating data</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr); <span class="fu">packageVersion</span>(<span class="st">&quot;tidyr&quot;</span>) <span class="co"># for creating the final graph at the end of the pipeline</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Hmisc); <span class="fu">packageVersion</span>(<span class="st">&quot;Hmisc&quot;</span>) <span class="co"># for creating the final graph at the end of the pipeline</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2); <span class="fu">packageVersion</span>(<span class="st">&quot;ggplot2&quot;</span>) <span class="co"># for creating the final graph at the end of the pipeline</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly); <span class="fu">packageVersion</span>(<span class="st">&quot;plotly&quot;</span>) <span class="co"># enables creation of interactive graphs, especially helpful for quality plots</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up pathway to cutadapt (primer trimming tool) and test</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>cutadapt <span class="ot">&lt;-</span> <span class="st">&quot;cutadapt&quot;</span> <span class="co"># CHANGE ME if not on premise; will probably look something like this: &quot;/usr/local/Python27/bin/cutadapt&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">system2</span>(cutadapt, <span class="at">args =</span> <span class="st">&quot;--version&quot;</span>) <span class="co"># Check by running shell command from R</span></span></code></pre></div>
<p>We will now set up the directories for the script. We’ll tell the script where our data is, and where we want to put the outputs of the script. We highly recommend NOT putting outputs of this script directly into your home directory, or into this tutorial directory. A better idea is to create a new project directory to hold the output each project you work on.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set path to shared data folder and contents</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data.fp <span class="ot">&lt;-</span> <span class="st">&quot;/mnt/home/ernakovich/shared/dada2_tutorial_data/16S&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># List all files in shared folder to check path</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(data.fp)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set file paths for barcodes file, map file, and fastqs</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Barcodes need to have &#39;N&#39; on the end of each 12bp sequence for compatability</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#map.fp &lt;- file.path(data.fp, &quot;Molecular_Methods_18_515fBC_16S_Mapping_File_SHORT_vFinal_Fierer_10252018.txt&quot;)</span></span></code></pre></div>
<p>Set up file paths in YOUR directory where you want data; you do not need to create the sub-directories but they are nice to have for organizational purposes.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>project.fp <span class="ot">&lt;-</span> <span class="st">&quot;~/Downloads/dada2_tutorial_test&quot;</span> <span class="co"># CHANGE ME to project directory; don&#39;t append with a &quot;/&quot;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(project.fp)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up names of sub directories to stay organized</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>preprocess.fp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(project.fp, <span class="st">&quot;01_preprocess&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>filtN.fp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(preprocess.fp, <span class="st">&quot;filtN&quot;</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>trimmed.fp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(preprocess.fp, <span class="st">&quot;trimmed&quot;</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>filter.fp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(project.fp, <span class="st">&quot;02_filter&quot;</span>) </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>table.fp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(project.fp, <span class="st">&quot;03_tabletax&quot;</span>) </span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>STOP - 00_setup_dada2_tutorial_16S.R:</strong> If you are running this on Premise, open up the 00_setup_dada2_tutorial_16S.R script with nano (or your favorite terminal text editor) and adjust the filepaths above appropriately.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h2 id="pre-processing-data-for-dada2---remove-sequences-with-ns-cutadapt">Pre-processing data for dada2 - remove sequences with Ns, cutadapt</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get full paths for all files and save them for downstream analyses</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward and reverse fastq filenames have format: </span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>fnFs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(data.fp, <span class="at">pattern=</span><span class="st">&quot;R1_&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>fnRs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(data.fp, <span class="at">pattern=</span><span class="st">&quot;R2_&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<h4 id="pre-filter-to-remove-sequence-reads-with-ns">Pre-filter to remove sequence reads with Ns</h4>
<p>Ambiguous bases will make it hard for cutadapt to find short primer sequences in the reads. To solve this problem, we will remove sequences with ambiguous bases (Ns)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Name the N-filtered files to put them in filtN/ subdirectory</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fnFs.filtN <span class="ot">&lt;-</span> <span class="fu">file.path</span>(preprocess.fp, <span class="st">&quot;filtN&quot;</span>, <span class="fu">basename</span>(fnFs))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>fnRs.filtN <span class="ot">&lt;-</span> <span class="fu">file.path</span>(preprocess.fp, <span class="st">&quot;filtN&quot;</span>, <span class="fu">basename</span>(fnRs))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter Ns from reads and put them into the filtN directory</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">filterAndTrim</span>(fnFs, fnFs.filtN, fnRs, fnRs.filtN, <span class="at">maxN =</span> <span class="dv">0</span>, <span class="at">multithread =</span> <span class="cn">TRUE</span>) </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># CHANGE multithread to FALSE on Windows (here and elsewhere in the program)</span></span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>Note:</strong> The <code>multithread = TRUE</code> setting can sometimes generate an error (names not equal). If this occurs, try rerunning the function. The error normally does not occur the second time.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h4 id="prepare-the-primers-sequences-and-custom-functions-for-analyzing-the-results-from-cutadapt">Prepare the primers sequences and custom functions for analyzing the results from cutadapt</h4>
<p>Assign the primers you used to “FWD” and “REV” below. Note primers should be not be reverse complemented ahead of time. Our tutorial data uses 515f and 926r those are the primers below. Change if you sequenced with other primers.</p>
<p><strong>For ITS data:</strong> <code>CTTGGTCATTTAGAGGAAGTAA</code> is the ITS forward primer sequence (ITS1F) and <code>GCTGCGTTCTTCATCGATGC</code> is ITS reverse primer sequence (ITS2). Using cutadapt to remove these primers will allow us to retain ITS sequences of variable biological length. See the dada2 creators’ ITS tutorial for more details.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the primer sequences to pass along to cutadapt</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>FWD <span class="ot">&lt;-</span> <span class="st">&quot;GTGYCAGCMGCCGCGGTAA&quot;</span>  <span class="do">## CHANGE ME # this is 515f</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>REV <span class="ot">&lt;-</span> <span class="st">&quot;CCGYCAATTYMTTTRAGTTT&quot;</span>  <span class="do">## CHANGE ME # this is 926r</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Write a function that creates a list of all orientations of the primers</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>allOrients <span class="ot">&lt;-</span> <span class="cf">function</span>(primer) {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create all orientations of the input sequence</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(Biostrings)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  dna <span class="ot">&lt;-</span> <span class="fu">DNAString</span>(primer)  <span class="co"># The Biostrings works w/ DNAString objects rather than character vectors</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  orients <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Forward =</span> dna, <span class="at">Complement =</span> <span class="fu">complement</span>(dna), <span class="at">Reverse =</span> <span class="fu">reverse</span>(dna), </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">RevComp =</span> <span class="fu">reverseComplement</span>(dna))</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sapply</span>(orients, toString))  <span class="co"># Convert back to character vector</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the primer orientations to pass to cutadapt</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>FWD.orients <span class="ot">&lt;-</span> <span class="fu">allOrients</span>(FWD)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>REV.orients <span class="ot">&lt;-</span> <span class="fu">allOrients</span>(REV)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>FWD.orients</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Write a function that counts how many time primers appear in a sequence</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>primerHits <span class="ot">&lt;-</span> <span class="cf">function</span>(primer, fn) {</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Counts number of reads in which the primer is found</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  nhits <span class="ot">&lt;-</span> <span class="fu">vcountPattern</span>(primer, <span class="fu">sread</span>(<span class="fu">readFastq</span>(fn)), <span class="at">fixed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>(nhits <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Before running cutadapt, we will look at primer detection for the first sample, as a check. There may be some primers here, we will remove them below using cutadapt.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">FWD.ForwardReads =</span> <span class="fu">sapply</span>(FWD.orients, primerHits, <span class="at">fn =</span> fnFs.filtN[[<span class="dv">1</span>]]), </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">FWD.ReverseReads =</span> <span class="fu">sapply</span>(FWD.orients, primerHits, <span class="at">fn =</span> fnRs.filtN[[<span class="dv">1</span>]]), </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">REV.ForwardReads =</span> <span class="fu">sapply</span>(REV.orients, primerHits, <span class="at">fn =</span> fnFs.filtN[[<span class="dv">1</span>]]), </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">REV.ReverseReads =</span> <span class="fu">sapply</span>(REV.orients, primerHits, <span class="at">fn =</span> fnRs.filtN[[<span class="dv">1</span>]]))</span></code></pre></div>
<h4 id="remove-primers-with-cutadapt-and-assess-the-output">Remove primers with cutadapt and assess the output</h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create directory to hold the output from cutadapt</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(trimmed.fp)) <span class="fu">dir.create</span>(trimmed.fp)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>fnFs.cut <span class="ot">&lt;-</span> <span class="fu">file.path</span>(trimmed.fp, <span class="fu">basename</span>(fnFs))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>fnRs.cut <span class="ot">&lt;-</span> <span class="fu">file.path</span>(trimmed.fp, <span class="fu">basename</span>(fnRs))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the reverse complements of the primers to variables</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>FWD.RC <span class="ot">&lt;-</span> dada2<span class="sc">:::</span><span class="fu">rc</span>(FWD)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>REV.RC <span class="ot">&lt;-</span> dada2<span class="sc">:::</span><span class="fu">rc</span>(REV)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  Create the cutadapt flags ##</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Trim FWD and the reverse-complement of REV off of R1 (forward reads)</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>R1.flags <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;-g&quot;</span>, FWD, <span class="st">&quot;-a&quot;</span>, REV.RC, <span class="st">&quot;--minimum-length 50&quot;</span>) </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Trim REV and the reverse-complement of FWD off of R2 (reverse reads)</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>R2.flags <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;-G&quot;</span>, REV, <span class="st">&quot;-A&quot;</span>, FWD.RC, <span class="st">&quot;--minimum-length 50&quot;</span>) </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Run Cutadapt</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(fnFs)) {</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system2</span>(cutadapt, <span class="at">args =</span> <span class="fu">c</span>(<span class="st">&quot;-j&quot;</span>, <span class="dv">0</span>, R1.flags, R2.flags, <span class="st">&quot;-n&quot;</span>, <span class="dv">2</span>, <span class="co"># -n 2 required to remove FWD and REV from reads</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;-o&quot;</span>, fnFs.cut[i], <span class="st">&quot;-p&quot;</span>, fnRs.cut[i], <span class="co"># output files</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                             fnFs.filtN[i], fnRs.filtN[i])) <span class="co"># input files</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co"># As a sanity check, we will check for primers in the first cutadapt-ed sample:</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="do">## should all be zero!</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">FWD.ForwardReads =</span> <span class="fu">sapply</span>(FWD.orients, primerHits, <span class="at">fn =</span> fnFs.cut[[<span class="dv">1</span>]]), </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">FWD.ReverseReads =</span> <span class="fu">sapply</span>(FWD.orients, primerHits, <span class="at">fn =</span> fnRs.cut[[<span class="dv">1</span>]]), </span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">REV.ForwardReads =</span> <span class="fu">sapply</span>(REV.orients, primerHits, <span class="at">fn =</span> fnFs.cut[[<span class="dv">1</span>]]), </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">REV.ReverseReads =</span> <span class="fu">sapply</span>(REV.orients, primerHits, <span class="at">fn =</span> fnRs.cut[[<span class="dv">1</span>]]))</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>STOP - 01_pre-process_dada2_tutorial_16S.R:</strong> If you are running this on Premise, open up the 01_pre-process_dada2_tutorial_16S.R script with <code>nano</code> (or your favorite terminal text editor) and adjust the primer sequences (if need be). After running it, check the slurm output to make sure that there are no primers still in your samples.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h1 id="now-start-dada2-pipeline">Now start DADA2 pipeline</h1>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Put filtered reads into separate sub-directories for big data workflow</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(filter.fp)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>subF.fp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(filter.fp, <span class="st">&quot;preprocessed_F&quot;</span>) </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>subR.fp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(filter.fp, <span class="st">&quot;preprocessed_R&quot;</span>) </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(subF.fp)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(subR.fp)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Move R1 and R2 from trimmed to separate forward/reverse sub-directories</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>fnFs.Q <span class="ot">&lt;-</span> <span class="fu">file.path</span>(subF.fp,  <span class="fu">basename</span>(fnFs)) </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>fnRs.Q <span class="ot">&lt;-</span> <span class="fu">file.path</span>(subR.fp,  <span class="fu">basename</span>(fnRs))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="fu">file.copy</span>(<span class="at">from =</span> fnFs.cut, <span class="at">to =</span> fnFs.Q)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">file.copy</span>(<span class="at">from =</span> fnRs.cut, <span class="at">to =</span> fnRs.Q)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># File parsing; create file names and make sure that forward and reverse files match</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>filtpathF <span class="ot">&lt;-</span> <span class="fu">file.path</span>(subF.fp, <span class="st">&quot;filtered&quot;</span>) <span class="co"># files go into preprocessed_F/filtered/</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>filtpathR <span class="ot">&lt;-</span> <span class="fu">file.path</span>(subR.fp, <span class="st">&quot;filtered&quot;</span>) <span class="co"># ...</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>fastqFs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(subF.fp, <span class="at">pattern=</span><span class="st">&quot;fastq.gz&quot;</span>))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>fastqRs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(subR.fp, <span class="at">pattern=</span><span class="st">&quot;fastq.gz&quot;</span>))</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(fastqFs) <span class="sc">!=</span> <span class="fu">length</span>(fastqRs)) <span class="fu">stop</span>(<span class="st">&quot;Forward and reverse files do not match.&quot;</span>)</span></code></pre></div>
<h3 id="1-filter-and-trim-for-quality">1. FILTER AND TRIM FOR QUALITY</h3>
<p>Before chosing sequence variants, we want to trim reads where their quality scores begin to drop (the <code>truncLen</code> and <code>truncQ</code> values) and remove any low-quality reads that are left over after we have finished trimming (the <code>maxEE</code> value).</p>
<p><strong>You will want to change this depending on run chemistry and quality:</strong> For 2x250 bp runs you can try <code>truncLen=c(240,160)</code> (as per the <a href="https://benjjneb.github.io/dada2/tutorial.html#inspect-read-quality-profiles">dada2 tutorial</a>) if your reverse reads drop off in quality. Or you may want to choose a higher value, for example, <code>truncLen=c(240,200)</code>, if they do not. In <code>truncLen=c(xxx,yyy)</code>, <code>xxx</code> refers to the forward read truncation length, <code>yyy</code> refers to the reverse read truncation length.</p>
<p><strong>For ITS data:</strong> Due to the expected variable read lengths in ITS data you should run this command without the <code>trunclen</code> parameter. See here for more information and appropriate parameters for ITS data: <a href="https://benjjneb.github.io/dada2/ITS_workflow.html">https://benjjneb.github.io/dada2/ITS_workflow.html</a>.</p>
<p><em>From dada2 tutorial:</em> &gt;If there is only one part of any amplicon bioinformatics workflow on which you spend time considering the parameters, it should be filtering! The parameters … are not set in stone, and should be changed if they don’t work for your data. If too few reads are passing the filter, increase maxEE and/or reduce truncQ. If quality drops sharply at the end of your reads, reduce truncLen. If your reads are high quality and you want to reduce computation time in the sample inference step, reduce maxEE.</p>
<h4 id="inspect-read-quality-profiles">Inspect read quality profiles</h4>
<p>It’s important to get a feel for the quality of the data that we are using. To do this, we will plot the quality of some of the samples.</p>
<p><em>From the dada2 tutorial:</em> &gt;In gray-scale is a heat map of the frequency of each quality score at each base position. The median quality score at each position is shown by the green line, and the quartiles of the quality score distribution by the orange lines. The red line shows the scaled proportion of reads that extend to at least that position (this is more useful for other sequencing technologies, as Illumina reads are typically all the same length, hence the flat red line).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If the number of samples is 20 or less, plot them all, otherwise, just plot 20 randomly selected samples</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>( <span class="fu">length</span>(fastqFs) <span class="sc">&lt;=</span> <span class="dv">20</span>) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  fwd_qual_plots <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(<span class="fu">paste0</span>(subF.fp, <span class="st">&quot;/&quot;</span>, fastqFs))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  rev_qual_plots <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(<span class="fu">paste0</span>(subR.fp, <span class="st">&quot;/&quot;</span>, fastqRs))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  rand_samples <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">size =</span> <span class="dv">20</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fastqFs)) <span class="co"># grab 20 random samples to plot</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  fwd_qual_plots <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(<span class="fu">paste0</span>(subF.fp, <span class="st">&quot;/&quot;</span>, fastqFs[rand_samples]))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  rev_qual_plots <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(<span class="fu">paste0</span>(subR.fp, <span class="st">&quot;/&quot;</span>, fastqRs[rand_samples]))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>fwd_qual_plots</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>rev_qual_plots</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Or, to make these quality plots interactive, just call the plots through plotly</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(fwd_qual_plots)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(rev_qual_plots)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write plots to disk</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fwd_qual_plots, <span class="fu">paste0</span>(filter.fp, <span class="st">&quot;/fwd_qual_plots.rds&quot;</span>))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(rev_qual_plots, <span class="fu">paste0</span>(filter.fp, <span class="st">&quot;/rev_qual_plots.rds&quot;</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> fwd_qual_plots, <span class="at">filename =</span> <span class="fu">paste0</span>(filter.fp, <span class="st">&quot;/fwd_qual_plots.png&quot;</span>), </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> rev_qual_plots, <span class="at">filename =</span> <span class="fu">paste0</span>(filter.fp, <span class="st">&quot;/rev_qual_plots.png&quot;</span>), </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>STOP - 02_check_quality_dada2_tutorial.R:</strong> If you are running this on Premise, run this script and download the plots generated here (fwd_qual_plots.png and rev_qual_plots.png). These are the pre-filtering plots, you should use them to make decisions for your filtering choices in the next step.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h4 id="filter-the-data">Filter the data</h4>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>WARNING:</strong> THESE PARAMETERS ARE NOT OPTIMAL FOR ALL DATASETS. Make sure you determine the trim and filtering parameters for your data. The following settings may be generally appropriate for NovaSeq runs that are 2x250 bp. For more information you can check the recommended default parameters from the dada2 pipeline. See above for more details.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>filt_out <span class="ot">&lt;-</span> <span class="fu">filterAndTrim</span>(<span class="at">fwd=</span><span class="fu">file.path</span>(subF.fp, fastqFs), <span class="at">filt=</span><span class="fu">file.path</span>(filtpathF, fastqFs),</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">rev=</span><span class="fu">file.path</span>(subR.fp, fastqRs), <span class="at">filt.rev=</span><span class="fu">file.path</span>(filtpathR, fastqRs),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">truncLen=</span><span class="fu">c</span>(<span class="dv">225</span>,<span class="dv">220</span>), <span class="at">maxEE=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">truncQ=</span><span class="dv">2</span>, <span class="at">maxN=</span><span class="dv">0</span>, <span class="at">rm.phix=</span><span class="cn">TRUE</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">compress=</span><span class="cn">TRUE</span>, <span class="at">verbose=</span><span class="cn">TRUE</span>, <span class="at">multithread=</span><span class="cn">TRUE</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># look at how many reads were kept</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(filt_out)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># summary of samples in filt_out by percentage</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>filt_out <span class="sc">%&gt;%</span> </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Samples =</span> <span class="fu">rownames</span>(.),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_kept =</span> <span class="dv">100</span><span class="sc">*</span>(reads.out<span class="sc">/</span>reads.in)) <span class="sc">%&gt;%</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Samples, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">min_remaining =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="fu">min</span>(percent_kept), <span class="dv">2</span>), <span class="st">&quot;%&quot;</span>), </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">median_remaining =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="fu">median</span>(percent_kept), <span class="dv">2</span>), <span class="st">&quot;%&quot;</span>),</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_remaining =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="fu">mean</span>(percent_kept), <span class="dv">2</span>), <span class="st">&quot;%&quot;</span>), </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_remaining =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="fu">max</span>(percent_kept), <span class="dv">2</span>), <span class="st">&quot;%&quot;</span>))</span></code></pre></div>
<p>Plot the quality of the filtered fastq files.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If the number of samples greater than 20 figure out which samples, if any, have been filtered out</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># so we won&#39;t try to plot them, otherwise just plot all the samples that remain</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>( <span class="fu">length</span>(fastqFs) <span class="sc">&lt;=</span> <span class="dv">20</span>) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  remaining_samplesF <span class="ot">&lt;-</span>  fastqFs[</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(fastqFs <span class="sc">%in%</span> <span class="fu">list.files</span>(filtpathF))] <span class="co"># keep only samples that haven&#39;t been filtered out</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  remaining_samplesR <span class="ot">&lt;-</span>  fastqRs[</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(fastqRs <span class="sc">%in%</span> <span class="fu">list.files</span>(filtpathR))] <span class="co"># keep only samples that haven&#39;t been filtered out</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  fwd_qual_plots_filt <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(<span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/&quot;</span>, remaining_samplesF))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  rev_qual_plots_filt <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(<span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/&quot;</span>, remaining_samplesR))</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  remaining_samplesF <span class="ot">&lt;-</span>  fastqFs[rand_samples][</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(fastqFs[rand_samples] <span class="sc">%in%</span> <span class="fu">list.files</span>(filtpathF))] <span class="co"># keep only samples that haven&#39;t been filtered out</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  remaining_samplesR <span class="ot">&lt;-</span>  fastqRs[rand_samples][</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(fastqRs[rand_samples] <span class="sc">%in%</span> <span class="fu">list.files</span>(filtpathR))] <span class="co"># keep only samples that haven&#39;t been filtered out</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  fwd_qual_plots_filt <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(<span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/&quot;</span>, remaining_samplesF))</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  rev_qual_plots_filt <span class="ot">&lt;-</span> <span class="fu">plotQualityProfile</span>(<span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/&quot;</span>, remaining_samplesR))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>fwd_qual_plots_filt</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>rev_qual_plots_filt</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co"># write plots to disk</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fwd_qual_plots_filt, <span class="fu">paste0</span>(filter.fp, <span class="st">&quot;/fwd_qual_plots_filt.rds&quot;</span>))</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(rev_qual_plots_filt, <span class="fu">paste0</span>(filter.fp, <span class="st">&quot;/rev_qual_plots_filt.rds&quot;</span>))</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> fwd_qual_plots_filt, <span class="at">filename =</span> <span class="fu">paste0</span>(filter.fp, <span class="st">&quot;/fwd_qual_plots_filt.png&quot;</span>), </span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> rev_qual_plots_filt, <span class="at">filename =</span> <span class="fu">paste0</span>(filter.fp, <span class="st">&quot;/rev_qual_plots_filt.png&quot;</span>), </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>STOP - 03_filter_reads_dada2_tutorial_16S.R:</strong> If you are running this on Premise, download the plots generated here (fwd_qual_plots_filt.png and rev_qual_plots_filt.png) and verify that your filtering is working the way you want it. If not, adjust the filterAndTrim() function and re-run this step with slurm.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h3 id="2-infer-sequence-variants">2. INFER sequence variants</h3>
<p>In this part of the pipeline dada2 will learn to distinguish error from biological differences using a subset of our data as a training set. After it understands the error rates, we will reduce the size of the dataset by combining all identical sequence reads into “unique sequences”. Then, using the dereplicated data and error rates, dada2 will infer the sequence variants (OTUs) in our data. Finally, we will merge the coresponding forward and reverse reads to create a list of the fully denoised sequences and create a sequence table from the result.</p>
<h4 id="housekeeping-step---set-up-and-verify-the-file-names-for-the">Housekeeping step - set up and verify the file names for the</h4>
<p>output:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># File parsing</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>filtFs <span class="ot">&lt;-</span> <span class="fu">list.files</span>(filtpathF, <span class="at">pattern=</span><span class="st">&quot;fastq.gz&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>filtRs <span class="ot">&lt;-</span> <span class="fu">list.files</span>(filtpathR, <span class="at">pattern=</span><span class="st">&quot;fastq.gz&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample names in order</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>sample.names <span class="ot">&lt;-</span> <span class="fu">substring</span>(<span class="fu">basename</span>(filtFs), <span class="fu">regexpr</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">basename</span>(filtFs)) <span class="sc">+</span> <span class="dv">1</span>) <span class="co"># doesn&#39;t drop fastq.gz</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>sample.names <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;_R1_001.fastq.gz&quot;</span>, <span class="st">&quot;&quot;</span>, sample.names)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>sample.namesR <span class="ot">&lt;-</span> <span class="fu">substring</span>(<span class="fu">basename</span>(filtRs), <span class="fu">regexpr</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">basename</span>(filtRs)) <span class="sc">+</span> <span class="dv">1</span>) <span class="co"># doesn&#39;t drop fastq.gz</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>sample.namesR <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;_R2_001.fastq.gz&quot;</span>, <span class="st">&quot;&quot;</span>, sample.namesR)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Double check</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">identical</span>(sample.names, sample.namesR)) <span class="fu">stop</span>(<span class="st">&quot;Forward and reverse files do not match.&quot;</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(filtFs) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(filtRs) <span class="ot">&lt;-</span> sample.names</span></code></pre></div>
<h4 id="learn-the-error-rates">Learn the error rates</h4>
<p>In this step we will learn the error rates for the sequencing run. Typically dada2 expects you to have data that has HiSeq or MiSeq-style quality scores - that is quality scores that range from 0-40. However, NovaSeq uses a technique called “binned” quality scores. This means that as quality scores are calculated from the sequencer, instead of assigning them a number between 0 and 40, they are instead assigned to 4 different quality scores, typically 0-40 scores are converted as shown below:</p>
<p>0-2 -&gt; 2<br />
3-14 -&gt; 11<br />
15-30 -&gt; 25<br />
31-40 -&gt; 37</p>
<p>This means that the <code>learnErrors</code> function has 1/10th of the information that it usually uses to learn the appropriate error function, which often leads to error plots with characteristic troughs in odd places. Although a definitive solution to this has not been found yet, several have been <a href="https://github.com/benjjneb/dada2/issues/1307">proposed</a>. Typically UNH sequencing data will be NovaSeq data, but it’s good to check. If you have data that doesn’t have binned error scores (i.e. MiSeq or HiSeq data) you can proceed to learn error rates in the typical way, and not worry about the modifications below. (Use <code>errF</code> and <code>errR</code> for the sequence-variant identification in the next step.) Otherwise, you should carefully inspect the error plots generated by each method below and choose the one that looks the best. Error rate plots that look good have black points that are very close to the black line and are continuously decreasing (especially in the right side of the plot).</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>) <span class="co"># set seed to ensure that randomized steps are replicatable</span></span></code></pre></div>
<h5 id="traditional-way-of-learning-error-rates">Traditional way of learning error rates</h5>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Learn forward error rates (Notes: randomize default is FALSE)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>errF <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(filtFs, <span class="at">nbases =</span> <span class="fl">1e10</span>, <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">randomize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Learn reverse error rates</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>errR <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(filtRs, <span class="at">nbases =</span> <span class="fl">1e10</span>, <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">randomize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errF, <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF.rds&quot;</span>))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errR, <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR.rds&quot;</span>))</span></code></pre></div>
<h5 id="four-options-for-learning-error-rates-with-novaseq-data">Four options for learning error rates with NovaSeq data</h5>
<p><strong>Option 1</strong> from JacobRPrice alter loess arguments (weights and span and enforce monotonicity)<br />
<a href="https://github.com/benjjneb/dada2/issues/1307">https://github.com/benjjneb/dada2/issues/1307</a></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>loessErrfun_mod_1 <span class="ot">&lt;-</span> <span class="cf">function</span>(trans) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  qq <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">colnames</span>(trans))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">0</span>, <span class="at">ncol=</span><span class="fu">length</span>(qq))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(nti <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)) {</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(ntj <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)) {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(nti <span class="sc">!=</span> ntj) {</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        errs <span class="ot">&lt;-</span> trans[<span class="fu">paste0</span>(nti,<span class="st">&quot;2&quot;</span>,ntj),]</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        tot <span class="ot">&lt;-</span> <span class="fu">colSums</span>(trans[<span class="fu">paste0</span>(nti,<span class="st">&quot;2&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)),])</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        rlogp <span class="ot">&lt;-</span> <span class="fu">log10</span>((errs<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span>tot)  <span class="co"># 1 psuedocount for each err, but if tot=0 will give NA</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        rlogp[<span class="fu">is.infinite</span>(rlogp)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">q=</span>qq, <span class="at">errs=</span>errs, <span class="at">tot=</span>tot, <span class="at">rlogp=</span>rlogp)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># original</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">###</span><span class="co">! mod.lo &lt;- loess(rlogp ~ q, df, weights=errs) </span><span class="al">###</span><span class="co">!</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mod.lo &lt;- loess(rlogp ~ q, df, weights=tot) </span><span class="al">###</span><span class="co">!</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #        mod.lo &lt;- loess(rlogp ~ q, df)</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gulliem Salazar&#39;s solution</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># https://github.com/benjjneb/dada2/issues/938</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        mod.lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(rlogp <span class="sc">~</span> q, df, <span class="at">weights =</span> <span class="fu">log10</span>(tot),<span class="at">span =</span> <span class="dv">2</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod.lo, qq)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        maxrli <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred)))</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        minrli <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred)))</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        pred[<span class="fu">seq_along</span>(pred)<span class="sc">&gt;</span>maxrli] <span class="ot">&lt;-</span> pred[[maxrli]]</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        pred[<span class="fu">seq_along</span>(pred)<span class="sc">&lt;</span>minrli] <span class="ot">&lt;-</span> pred[[minrli]]</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        est <span class="ot">&lt;-</span> <span class="fu">rbind</span>(est, <span class="dv">10</span><span class="sc">^</span>pred)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>      } <span class="co"># if(nti != ntj)</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    } <span class="co"># for(ntj in c(&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;))</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># for(nti in c(&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;))</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># HACKY</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  MAX_ERROR_RATE <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>  MIN_ERROR_RATE <span class="ot">&lt;-</span> <span class="fl">1e-7</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  est[est<span class="sc">&gt;</span>MAX_ERROR_RATE] <span class="ot">&lt;-</span> MAX_ERROR_RATE</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  est[est<span class="sc">&lt;</span>MIN_ERROR_RATE] <span class="ot">&lt;-</span> MIN_ERROR_RATE</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforce monotonicity</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># https://github.com/benjjneb/dada2/issues/791</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  estorig <span class="ot">&lt;-</span> est</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> est <span class="sc">%&gt;%</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_all</span>(<span class="fu">funs</span>(<span class="fu">case_when</span>(. <span class="sc">&lt;</span> X40 <span class="sc">~</span> X40,</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>                              . <span class="sc">&gt;=</span> X40 <span class="sc">~</span> .))) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(est) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(estorig)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(est) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(estorig)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Expand the err matrix with the self-transition probs</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>  err <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]), est[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,],</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">4</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>,]), est[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>,],</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>,]), est[<span class="dv">9</span>,],</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,]))</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(err) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>), <span class="at">each=</span><span class="dv">4</span>), <span class="st">&quot;2&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>))</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(err) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(trans)</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(err)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a><span class="co"># check what this looks like</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>errF_1 <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>  filtFs,</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">nbases =</span> <span class="fl">1e10</span>,</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">errorEstimationFunction =</span> loessErrfun_mod1,</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>errR_1 <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>  filtRs,</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">nbases =</span> <span class="fl">1e10</span>,</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">errorEstimationFunction =</span> loessErrfun_mod1,</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>Option 2</strong> enforce monotonicity only.<br />
Originally recommended in: <a href="https://github.com/benjjneb/dada2/issues/791">https://github.com/benjjneb/dada2/issues/791</a></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>loessErrfun_mod2 <span class="ot">&lt;-</span> <span class="cf">function</span>(trans) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  qq <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">colnames</span>(trans))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">0</span>, <span class="at">ncol=</span><span class="fu">length</span>(qq))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(nti <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)) {</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(ntj <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)) {</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(nti <span class="sc">!=</span> ntj) {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        errs <span class="ot">&lt;-</span> trans[<span class="fu">paste0</span>(nti,<span class="st">&quot;2&quot;</span>,ntj),]</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        tot <span class="ot">&lt;-</span> <span class="fu">colSums</span>(trans[<span class="fu">paste0</span>(nti,<span class="st">&quot;2&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)),])</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        rlogp <span class="ot">&lt;-</span> <span class="fu">log10</span>((errs<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span>tot)  <span class="co"># 1 psuedocount for each err, but if tot=0 will give NA</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        rlogp[<span class="fu">is.infinite</span>(rlogp)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">q=</span>qq, <span class="at">errs=</span>errs, <span class="at">tot=</span>tot, <span class="at">rlogp=</span>rlogp)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># original</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">###</span><span class="co">! mod.lo &lt;- loess(rlogp ~ q, df, weights=errs) </span><span class="al">###</span><span class="co">!</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        mod.lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(rlogp <span class="sc">~</span> q, df, <span class="at">weights=</span>tot) <span class="do">###!</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #        mod.lo &lt;- loess(rlogp ~ q, df)</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gulliem Salazar&#39;s solution</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># https://github.com/benjjneb/dada2/issues/938</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mod.lo &lt;- loess(rlogp ~ q, df, weights = log10(tot),span = 2)</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod.lo, qq)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        maxrli <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred)))</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        minrli <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred)))</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        pred[<span class="fu">seq_along</span>(pred)<span class="sc">&gt;</span>maxrli] <span class="ot">&lt;-</span> pred[[maxrli]]</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        pred[<span class="fu">seq_along</span>(pred)<span class="sc">&lt;</span>minrli] <span class="ot">&lt;-</span> pred[[minrli]]</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        est <span class="ot">&lt;-</span> <span class="fu">rbind</span>(est, <span class="dv">10</span><span class="sc">^</span>pred)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>      } <span class="co"># if(nti != ntj)</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    } <span class="co"># for(ntj in c(&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;))</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># for(nti in c(&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;))</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># HACKY</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  MAX_ERROR_RATE <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  MIN_ERROR_RATE <span class="ot">&lt;-</span> <span class="fl">1e-7</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  est[est<span class="sc">&gt;</span>MAX_ERROR_RATE] <span class="ot">&lt;-</span> MAX_ERROR_RATE</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  est[est<span class="sc">&lt;</span>MIN_ERROR_RATE] <span class="ot">&lt;-</span> MIN_ERROR_RATE</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforce monotonicity</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># https://github.com/benjjneb/dada2/issues/791</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  estorig <span class="ot">&lt;-</span> est</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> est <span class="sc">%&gt;%</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_all</span>(<span class="fu">funs</span>(<span class="fu">case_when</span>(. <span class="sc">&lt;</span> X40 <span class="sc">~</span> X40,</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>                              . <span class="sc">&gt;=</span> X40 <span class="sc">~</span> .))) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(est) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(estorig)</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(est) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(estorig)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Expand the err matrix with the self-transition probs</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>  err <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]), est[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,],</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">4</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>,]), est[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>,],</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>,]), est[<span class="dv">9</span>,],</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,]))</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(err) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>), <span class="at">each=</span><span class="dv">4</span>), <span class="st">&quot;2&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>))</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(err) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(trans)</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(err)</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a><span class="co"># check what this looks like</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>errF_2 <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>  filtFs,</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">nbases =</span> <span class="fl">1e10</span>,</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">errorEstimationFunction =</span> loessErrfun_mod2,</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>errR_2 <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>  filtRs,</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">nbases =</span> <span class="fl">1e10</span>,</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">errorEstimationFunction =</span> loessErrfun_mod2,</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>Option 3</strong> alter loess function (weights only) and enforce monotonicity<br />
From JacobRPrice <a href="https://github.com/benjjneb/dada2/issues/1307">https://github.com/benjjneb/dada2/issues/1307</a></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>loessErrfun_mod3 <span class="ot">&lt;-</span> <span class="cf">function</span>(trans) {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  qq <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">colnames</span>(trans))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">0</span>, <span class="at">ncol=</span><span class="fu">length</span>(qq))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(nti <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)) {</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(ntj <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)) {</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(nti <span class="sc">!=</span> ntj) {</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        errs <span class="ot">&lt;-</span> trans[<span class="fu">paste0</span>(nti,<span class="st">&quot;2&quot;</span>,ntj),]</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        tot <span class="ot">&lt;-</span> <span class="fu">colSums</span>(trans[<span class="fu">paste0</span>(nti,<span class="st">&quot;2&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)),])</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        rlogp <span class="ot">&lt;-</span> <span class="fu">log10</span>((errs<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span>tot)  <span class="co"># 1 psuedocount for each err, but if tot=0 will give NA</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        rlogp[<span class="fu">is.infinite</span>(rlogp)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">q=</span>qq, <span class="at">errs=</span>errs, <span class="at">tot=</span>tot, <span class="at">rlogp=</span>rlogp)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># original</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">###</span><span class="co">! mod.lo &lt;- loess(rlogp ~ q, df, weights=errs) </span><span class="al">###</span><span class="co">!</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mod.lo &lt;- loess(rlogp ~ q, df, weights=tot) </span><span class="al">###</span><span class="co">!</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #        mod.lo &lt;- loess(rlogp ~ q, df)</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gulliem Salazar&#39;s solution</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># https://github.com/benjjneb/dada2/issues/938</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mod.lo &lt;- loess(rlogp ~ q, df, weights = log10(tot),span = 2)</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># only change the weights</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        mod.lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(rlogp <span class="sc">~</span> q, df, <span class="at">weights =</span> <span class="fu">log10</span>(tot))</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod.lo, qq)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        maxrli <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred)))</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        minrli <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred)))</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        pred[<span class="fu">seq_along</span>(pred)<span class="sc">&gt;</span>maxrli] <span class="ot">&lt;-</span> pred[[maxrli]]</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        pred[<span class="fu">seq_along</span>(pred)<span class="sc">&lt;</span>minrli] <span class="ot">&lt;-</span> pred[[minrli]]</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>        est <span class="ot">&lt;-</span> <span class="fu">rbind</span>(est, <span class="dv">10</span><span class="sc">^</span>pred)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>      } <span class="co"># if(nti != ntj)</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    } <span class="co"># for(ntj in c(&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;))</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># for(nti in c(&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;))</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># HACKY</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  MAX_ERROR_RATE <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  MIN_ERROR_RATE <span class="ot">&lt;-</span> <span class="fl">1e-7</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  est[est<span class="sc">&gt;</span>MAX_ERROR_RATE] <span class="ot">&lt;-</span> MAX_ERROR_RATE</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  est[est<span class="sc">&lt;</span>MIN_ERROR_RATE] <span class="ot">&lt;-</span> MIN_ERROR_RATE</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforce monotonicity</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># https://github.com/benjjneb/dada2/issues/791</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>  estorig <span class="ot">&lt;-</span> est</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> est <span class="sc">%&gt;%</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_all</span>(<span class="fu">funs</span>(<span class="fu">case_when</span>(. <span class="sc">&lt;</span> X40 <span class="sc">~</span> X40,</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>                              . <span class="sc">&gt;=</span> X40 <span class="sc">~</span> .))) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(est) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(estorig)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(est) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(estorig)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Expand the err matrix with the self-transition probs</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>  err <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]), est[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,],</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">4</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>,]), est[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>,],</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>,]), est[<span class="dv">9</span>,],</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,]))</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(err) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>), <span class="at">each=</span><span class="dv">4</span>), <span class="st">&quot;2&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>))</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(err) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(trans)</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(err)</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="co"># check what this looks like</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>errF_3 <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>  filtFs,</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">nbases =</span> <span class="fl">1e10</span>,</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">errorEstimationFunction =</span> loessErrfun_mod3,</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="co"># check what this looks like</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>errR_3 <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>  filtRs,</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">nbases =</span> <span class="fl">1e10</span>,</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">errorEstimationFunction =</span> loessErrfun_mod3,</span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>Option 4</strong> Alter loess function arguments (weights and span and degree, also enforce monotonicity)<br />
From Jonalim’s comment in <a href="https://github.com/benjjneb/dada2/issues/1307">https://github.com/benjjneb/dada2/issues/1307</a></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>loessErrfun_mod4 <span class="ot">&lt;-</span> <span class="cf">function</span>(trans) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  qq <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">colnames</span>(trans))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">0</span>, <span class="at">ncol=</span><span class="fu">length</span>(qq))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(nti <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)) {</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(ntj <span class="cf">in</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)) {</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(nti <span class="sc">!=</span> ntj) {</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        errs <span class="ot">&lt;-</span> trans[<span class="fu">paste0</span>(nti,<span class="st">&quot;2&quot;</span>,ntj),]</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        tot <span class="ot">&lt;-</span> <span class="fu">colSums</span>(trans[<span class="fu">paste0</span>(nti,<span class="st">&quot;2&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>)),])</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        rlogp <span class="ot">&lt;-</span> <span class="fu">log10</span>((errs<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span>tot)  <span class="co"># 1 psuedocount for each err, but if tot=0 will give NA</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        rlogp[<span class="fu">is.infinite</span>(rlogp)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">q=</span>qq, <span class="at">errs=</span>errs, <span class="at">tot=</span>tot, <span class="at">rlogp=</span>rlogp)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># original</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">###</span><span class="co">! mod.lo &lt;- loess(rlogp ~ q, df, weights=errs) </span><span class="al">###</span><span class="co">!</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mod.lo &lt;- loess(rlogp ~ q, df, weights=tot) </span><span class="al">###</span><span class="co">!</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #        mod.lo &lt;- loess(rlogp ~ q, df)</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># jonalim&#39;s solution</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># https://github.com/benjjneb/dada2/issues/938</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        mod.lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(rlogp <span class="sc">~</span> q, df, <span class="at">weights =</span> <span class="fu">log10</span>(tot),<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">span =</span> <span class="fl">0.95</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod.lo, qq)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        maxrli <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred)))</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        minrli <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred)))</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        pred[<span class="fu">seq_along</span>(pred)<span class="sc">&gt;</span>maxrli] <span class="ot">&lt;-</span> pred[[maxrli]]</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        pred[<span class="fu">seq_along</span>(pred)<span class="sc">&lt;</span>minrli] <span class="ot">&lt;-</span> pred[[minrli]]</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        est <span class="ot">&lt;-</span> <span class="fu">rbind</span>(est, <span class="dv">10</span><span class="sc">^</span>pred)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>      } <span class="co"># if(nti != ntj)</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    } <span class="co"># for(ntj in c(&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;))</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># for(nti in c(&quot;A&quot;,&quot;C&quot;,&quot;G&quot;,&quot;T&quot;))</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># HACKY</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  MAX_ERROR_RATE <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  MIN_ERROR_RATE <span class="ot">&lt;-</span> <span class="fl">1e-7</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>  est[est<span class="sc">&gt;</span>MAX_ERROR_RATE] <span class="ot">&lt;-</span> MAX_ERROR_RATE</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  est[est<span class="sc">&lt;</span>MIN_ERROR_RATE] <span class="ot">&lt;-</span> MIN_ERROR_RATE</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforce monotonicity</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># https://github.com/benjjneb/dada2/issues/791</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>  estorig <span class="ot">&lt;-</span> est</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> est <span class="sc">%&gt;%</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_all</span>(<span class="fu">funs</span>(<span class="fu">case_when</span>(. <span class="sc">&lt;</span> X40 <span class="sc">~</span> X40,</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>                              . <span class="sc">&gt;=</span> X40 <span class="sc">~</span> .))) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(est) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(estorig)</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(est) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(estorig)</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Expand the err matrix with the self-transition probs</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>  err <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]), est[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,],</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">4</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>,]), est[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>,],</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>,]), est[<span class="dv">9</span>,],</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>               est[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,], <span class="dv">1</span><span class="sc">-</span><span class="fu">colSums</span>(est[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,]))</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(err) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>), <span class="at">each=</span><span class="dv">4</span>), <span class="st">&quot;2&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;T&quot;</span>))</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(err) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(trans)</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(err)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a><span class="co"># check what this looks like</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>errF_4 <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>  filtFs,</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">nbases =</span> <span class="fl">1e10</span>,</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">errorEstimationFunction =</span> loessErrfun_mod4,</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>errR_4 <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>  filtRs,</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">nbases =</span> <span class="fl">1e10</span>,</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">errorEstimationFunction =</span> loessErrfun_mod4,</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<h4 id="plot-error-rates">Plot Error Rates</h4>
<p>We want to make sure that the machine learning algorithm is learning the error rates properly. In the plots below, the red line represents what we should expect the learned error rates to look like for each of the 16 possible base transitions (A-&gt;A, A-&gt;C, A-&gt;G, etc.) and the black line and grey dots represent what the observed error rates are. If the black line and the red lines are very far off from each other, it may be a good idea to increase the <code>nbases</code> parameter. This allows the machine learning algorthim to train on a larger portion of your data and may help improve the fit.</p>
<p>If you have NovaSeq data, you will notice a characteristic dip in the default error plots and you may have points that are far off of the line. This is typical and you will likely want to use one of the other options for error rate functions as simply increasing <code>nbases</code> will not solve this problem. There are four options, none of which will yield “ideal” error plots. Instead look for the solution where the black line is continuously decreasing (i.e. as quality scores improve on the x-axis the predicted error rate (y-axis) goes down) and for plots that have points that mostly align with the black lines, although you will likely have some points along 0 on the y-axis.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original default recommended way (not optimal for NovaSeq data!)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>errF_plot <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errF, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>errR_plot <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errR, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errF_plot, <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot.rds&quot;</span>))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errR_plot, <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot.rds&quot;</span>))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errF_plot, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot.png&quot;</span>), </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errR_plot, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errR_plot.png&quot;</span>), </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Trial 1 (alter span and weight in loess, enforce montonicity)</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>errF_plot1 <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errF_1, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>errR_plot1 <span class="ot">&lt;-</span><span class="fu">plotErrors</span>(errR_1, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errF_plot1, <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot1.rds&quot;</span>))</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errR_plot1, <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot1.rds&quot;</span>))</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errF_plot1, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot1.png&quot;</span>), </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errR_plot1, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot1.png&quot;</span>), </span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Trial 2 (only enforce monotonicity - don&#39;t change the loess function)</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>errF_plot2 <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errF_2, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>errR_plot2 <span class="ot">&lt;-</span><span class="fu">plotErrors</span>(errR_2, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errF_plot2, <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot2.rds&quot;</span>))</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errR_plot2, <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot2.rds&quot;</span>))</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errF_plot2, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot2.png&quot;</span>), </span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errR_plot2, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot2.png&quot;</span>), </span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Trial 3 (alter loess (weights only) and enforce monotonicity)</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>errF_plot3 <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errF_3, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>errR_plot3 <span class="ot">&lt;-</span><span class="fu">plotErrors</span>(errR_3, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errF_plot3, <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot3.rds&quot;</span>))</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errR_plot3, <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot3.rds&quot;</span>))</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errF_plot3, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot3.png&quot;</span>), </span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errR_plot3, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot3.png&quot;</span>), </span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Trial 4 (alter loess (span, weight, and degree) and enforce monotonicity)</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>errF_plot4 <span class="ot">&lt;-</span> <span class="fu">plotErrors</span>(errF_4, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>errR_plot4 <span class="ot">&lt;-</span><span class="fu">plotErrors</span>(errR_4, <span class="at">nominalQ =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errF_plot4, <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot4.rds&quot;</span>))</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(errR_plot4, <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot4.rds&quot;</span>))</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errF_plot4, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathF, <span class="st">&quot;/errF_plot4.png&quot;</span>),</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> errR_plot4, <span class="at">filename =</span> <span class="fu">paste0</span>(filtpathR, <span class="st">&quot;/errR_plot4.png&quot;</span>),</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>STOP - 04_learn_error_rates_dada2_tutorial_16S.R:</strong> If you are running this on Premise, download the plots generated here (They will be found in the 02_filter/preprocessed_F/filter and 02_filter/preprocessed_R/filter folder) and verify that the error plots look appropriate. If not, adjust the learnErrors() function and re-run this step with slurm.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h4 id="dereplication-sequence-inference-and-merging-of-paired-end-reads">Dereplication, sequence inference, and merging of paired-end reads</h4>
<p>In this part of the pipeline, dada2 will make decisions about assigning sequences to ASVs (called “sequence inference”). There is a major parameter option in the core function dada() that changes how samples are handled during sequence inference. The parameter <code>pool =</code> can be set to: <code>pool = FALSE</code> (default), <code>pool = TRUE</code>, or <code>pool = psuedo</code>. For details on parameter choice, please see below, and further information on this blogpost <a href="http://fiererlab.org/2020/02/17/whats-in-a-number-estimating-microbial-richness-using-dada2/">http://fiererlab.org/2020/02/17/whats-in-a-number-estimating-microbial-richness-using-dada2/</a>, and explanation on the dada2 tutorial <a href="https://benjjneb.github.io/dada2/pool.html">https://benjjneb.github.io/dada2/pool.html</a>.</p>
<p><strong>Details</strong><br />
<code>pool = FALSE</code>: Sequence information is not shared between samples. Fast processing time, less sensitivity to rare taxa.<br />
<code>pool = psuedo</code>: Sequence information is shared in a separate “prior” step. Intermediate processing time, intermediate sensitivity to rare taxa.<br />
<code>pool = TRUE</code>: Sequence information from all samples is pooled together. Slow processing time, most sensitivity to rare taxa.</p>
<h4 id="default-samples-not-pooled">Default: SAMPLES NOT POOLED</h4>
<p>For simple communities or when you do not need high sensitivity for rare taxa</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make lists to hold the loop output</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>mergers <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="fu">length</span>(sample.names))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mergers) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>ddF <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="fu">length</span>(sample.names))</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ddF) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>ddR <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="fu">length</span>(sample.names))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ddR) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># For each sample, get a list of merged and denoised sequences</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(sam <span class="cf">in</span> sample.names) {</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Processing:&quot;</span>, sam, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dereplicate forward reads</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  derepF <span class="ot">&lt;-</span> <span class="fu">derepFastq</span>(filtFs[[sam]])</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Infer sequences for forward reads</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  dadaF <span class="ot">&lt;-</span> <span class="fu">dada</span>(derepF, <span class="at">err =</span> errF, <span class="at">multithread =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  ddF[[sam]] <span class="ot">&lt;-</span> dadaF</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dereplicate reverse reads</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  derepR <span class="ot">&lt;-</span> <span class="fu">derepFastq</span>(filtRs[[sam]])</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Infer sequences for reverse reads</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  dadaR <span class="ot">&lt;-</span> <span class="fu">dada</span>(derepR, <span class="at">err =</span> errR, <span class="at">multithread =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  ddR[[sam]] <span class="ot">&lt;-</span> dadaR</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge reads together</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  merger <span class="ot">&lt;-</span> <span class="fu">mergePairs</span>(ddF[[sam]], derepF, ddR[[sam]], derepR)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  mergers[[sam]] <span class="ot">&lt;-</span> merger</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(derepF); <span class="fu">rm</span>(derepR)</span></code></pre></div>
<h4 id="alternative-samples-pooled">Alternative: SAMPLES POOLED</h4>
<p>For complex communities when you want to preserve rare taxa alternative: swap <code>pool = TRUE</code> with <code>pool = &quot;pseudo&quot;</code></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># same steps, not in loop</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Dereplicate forward reads</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">#derepF.p &lt;- derepFastq(filtFs)</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#names(derepF.p) &lt;- sample.names</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Infer sequences for forward reads</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">#dadaF.p &lt;- dada(derepF.p, err = errF, multithread = TRUE, pool = TRUE)</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">#names(dadaF.p) &lt;- sample.names</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Dereplicate reverse reads</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">#derepR.p &lt;- derepFastq(filtRs)</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">#names(derepR.p) &lt;- sample.names</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Infer sequences for reverse reads</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">#dadaR.p &lt;- dada(derepR.p, err = errR, multithread = TRUE, pool = TRUE)</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">#names(dadaR.p) &lt;- sample.names</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge reads together</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co">#mergers &lt;- mergePairs(dadaF.p, derepF.p, dadaR.p, derepR.p)</span></span></code></pre></div>
<h4 id="construct-sequence-table">Construct sequence table</h4>
<p>You will always perform this step whether or not you have pooled or unpooled ASV picking</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>seqtab <span class="ot">&lt;-</span> <span class="fu">makeSequenceTable</span>(mergers)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Save table as an r data object file</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(table.fp)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(seqtab, <span class="fu">paste0</span>(table.fp, <span class="st">&quot;/seqtab.rds&quot;</span>))</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>STOP - 05_infer_ASVs_dada2_tutorial_16S.R:</strong> If you are running this on Premise, decide if you want the pooled or not-pooled option delete the options you don’t want before running this step with slurm. Also make sure to change the error rate model being used if you are not using the default errR and errF. You can change it in the <code>dada()</code> function option <code>err</code>. Make sure that you change it for both the forward and reverse reads. (You will likely need to change it if you have NovaSeq data.)</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h3 id="3-remove-chimeras-and-assign-taxonomy">3. REMOVE Chimeras and ASSIGN Taxonomy</h3>
<p>Although dada2 has searched for indel errors and subsitutions, there may still be chimeric sequences in our dataset (sequences that are derived from forward and reverse sequences from two different organisms becoming fused together during PCR and/or sequencing). To identify chimeras, we will search for rare sequence variants that can be reconstructed by combining left-hand and right-hand segments from two more abundant “parent” sequences. After removing chimeras, we will use a taxonomy database to train a classifer-algorithm to assign names to our sequence variants.</p>
<p>For the tutorial 16S, we will assign taxonomy with Silva db v138, but you might want to use other databases for your data. Below are paths to some of the databases we use often. (If you are on your own computer you can download the database you need from this link <a href="https://benjjneb.github.io/dada2/training.html">https://benjjneb.github.io/dada2/training.html</a>):</p>
<ul>
<li><p>16S bacteria and archaea (SILVA db): <code>/mnt/home/ernakovich/shared/db_files/dada2/silva_nr99_v138_train_set.fa</code></p></li>
<li><p>ITS fungi (UNITE db): <code>/mnt/home/ernakovich/shared/db_files/dada2/UNITE_sh_general_release_10.05.2021/sh_general_release_dynamic_10.05.2021.fasta</code></p></li>
<li><p>18S protists (PR2 db): <code>/mnt/home/ernakovich/shared/db_files/dada2/pr2_version_4.14.0_SSU_dada2.fasta</code></p></li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in RDS </span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>st.all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(table.fp, <span class="st">&quot;/seqtab.rds&quot;</span>))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove chimeras</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">removeBimeraDenovo</span>(st.all, <span class="at">method=</span><span class="st">&quot;consensus&quot;</span>, <span class="at">multithread=</span><span class="cn">TRUE</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print percentage of our seqences that were not chimeric.</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="dv">100</span><span class="sc">*</span><span class="fu">sum</span>(seqtab.nochim)<span class="sc">/</span><span class="fu">sum</span>(seqtab)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign taxonomy</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>tax <span class="ot">&lt;-</span> <span class="fu">assignTaxonomy</span>(seqtab.nochim, <span class="st">&quot;/mnt/home/ernakovich/shared/db_files/dada2/silva_nr99_v138_train_set.fa&quot;</span>, <span class="at">tryRC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">multithread=</span><span class="cn">TRUE</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Write results to disk</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(seqtab.nochim, <span class="fu">paste0</span>(table.fp, <span class="st">&quot;/seqtab_final.rds&quot;</span>))</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(tax, <span class="fu">paste0</span>(table.fp, <span class="st">&quot;/tax_final.rds&quot;</span>))</span></code></pre></div>
<h3 id="4-optional---format-output-to-obtain-asv-ids-and-repset-and-input-for-mctoolsr">4. Optional - FORMAT OUTPUT to obtain ASV IDs and repset, and input for mctoolsr</h3>
<p>For convenience sake, we will now rename our ASVs with numbers, output our results as a traditional taxa table, and create a matrix with the representative sequences for each ASV.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flip table</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>seqtab.t <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(seqtab.nochim))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull out ASV repset</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>rep_set_ASVs <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rownames</span>(seqtab.t))</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>rep_set_ASVs <span class="ot">&lt;-</span> <span class="fu">mutate</span>(rep_set_ASVs, <span class="at">ASV_ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>rep_set_ASVs<span class="sc">$</span>ASV_ID <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;^&quot;</span>, <span class="st">&quot;ASV_&quot;</span>, rep_set_ASVs<span class="sc">$</span>ASV_ID)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>rep_set_ASVs<span class="sc">$</span>ASV <span class="ot">&lt;-</span> rep_set_ASVs<span class="sc">$</span><span class="st">`</span><span class="at">rownames(seqtab.t)</span><span class="st">`</span> </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>rep_set_ASVs<span class="sc">$</span><span class="st">`</span><span class="at">rownames(seqtab.t)</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ASV numbers to table</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(seqtab.t) <span class="ot">&lt;-</span> rep_set_ASVs<span class="sc">$</span>ASV_ID</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ASV numbers to taxonomy</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>taxonomy <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(tax)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>taxonomy<span class="sc">$</span>ASV <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rownames</span>(taxonomy))</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>taxonomy <span class="ot">&lt;-</span> <span class="fu">merge</span>(rep_set_ASVs, taxonomy, <span class="at">by =</span> <span class="st">&quot;ASV&quot;</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(taxonomy) <span class="ot">&lt;-</span> taxonomy<span class="sc">$</span>ASV_ID</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>taxonomy_for_mctoolsr <span class="ot">&lt;-</span> <span class="fu">unite_</span>(taxonomy, <span class="st">&quot;taxonomy&quot;</span>, </span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">c</span>(<span class="st">&quot;Kingdom&quot;</span>, <span class="st">&quot;Phylum&quot;</span>, <span class="st">&quot;Class&quot;</span>, <span class="st">&quot;Order&quot;</span>,<span class="st">&quot;Family&quot;</span>, <span class="st">&quot;Genus&quot;</span>, <span class="st">&quot;ASV_ID&quot;</span>),</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>                                <span class="at">sep =</span> <span class="st">&quot;;&quot;</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Write repset to fasta file</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co"># create a function that writes fasta sequences</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>writeRepSetFasta<span class="ot">&lt;-</span><span class="cf">function</span>(data, filename){</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  fastaLines <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (rowNum <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)){</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    fastaLines <span class="ot">=</span> <span class="fu">c</span>(fastaLines, <span class="fu">as.character</span>(<span class="fu">paste</span>(<span class="st">&quot;&gt;&quot;</span>, data[rowNum,<span class="st">&quot;name&quot;</span>], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)))</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    fastaLines <span class="ot">=</span> <span class="fu">c</span>(fastaLines,<span class="fu">as.character</span>(data[rowNum,<span class="st">&quot;seq&quot;</span>]))</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  fileConn<span class="ot">&lt;-</span><span class="fu">file</span>(filename)</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(fastaLines, fileConn)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(fileConn)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrange the taxonomy dataframe for the writeRepSetFasta function</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>taxonomy_for_fasta <span class="ot">&lt;-</span> taxonomy <span class="sc">%&gt;%</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unite</span>(<span class="st">&quot;TaxString&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;Kingdom&quot;</span>, <span class="st">&quot;Phylum&quot;</span>, <span class="st">&quot;Class&quot;</span>, <span class="st">&quot;Order&quot;</span>,<span class="st">&quot;Family&quot;</span>, <span class="st">&quot;Genus&quot;</span>, <span class="st">&quot;ASV_ID&quot;</span>), </span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">&quot;;&quot;</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unite</span>(<span class="st">&quot;name&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;ASV_ID&quot;</span>, <span class="st">&quot;TaxString&quot;</span>), </span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">&quot; &quot;</span>, <span class="at">remove =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ASV, name) <span class="sc">%&gt;%</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">seq =</span> ASV)</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="co"># write fasta file</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRepSetFasta</span>(taxonomy_for_fasta, <span class="fu">paste0</span>(table.fp, <span class="st">&quot;/repset.fasta&quot;</span>))</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge taxonomy and table</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>seqtab_wTax <span class="ot">&lt;-</span> <span class="fu">merge</span>(seqtab.t, taxonomy_for_mctoolsr, <span class="at">by =</span> <span class="dv">0</span>)</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>seqtab_wTax<span class="sc">$</span>ASV <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Set name of table in mctoolsr format and save</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>out_fp <span class="ot">&lt;-</span> <span class="fu">paste0</span>(table.fp, <span class="st">&quot;/seqtab_wTax_mctoolsr.txt&quot;</span>)</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(seqtab_wTax)[<span class="dv">1</span>] <span class="ot">=</span> <span class="st">&quot;#ASV_ID&quot;</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;#Exported for mctoolsr&quot;</span>, out_fp)</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressWarnings</span>(<span class="fu">write.table</span>(seqtab_wTax, out_fp, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">append =</span> <span class="cn">TRUE</span>))</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Also export files as .txt</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(seqtab.t, <span class="at">file =</span> <span class="fu">paste0</span>(table.fp, <span class="st">&quot;/seqtab_final.txt&quot;</span>),</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>            <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">row.names =</span> <span class="cn">TRUE</span>, <span class="at">col.names =</span> <span class="cn">NA</span>)</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(tax, <span class="at">file =</span> <span class="fu">paste0</span>(table.fp, <span class="st">&quot;/tax_final.txt&quot;</span>), </span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>            <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">row.names =</span> <span class="cn">TRUE</span>, <span class="at">col.names =</span> <span class="cn">NA</span>)</span></code></pre></div>
<h3 id="summary-of-output-files">Summary of output files:</h3>
<ol style="list-style-type: decimal">
<li>seqtab_final.txt - A tab-delimited sequence-by-sample (i.e. OTU) table</li>
<li>tax_final.txt - a tab-demlimited file showing the relationship between ASVs, ASV IDs, and their taxonomy</li>
<li>seqtab_wTax_mctoolsr.txt - a tab-delimited file with ASVs as rows, samples as columns and the final column showing the taxonomy of the ASV ID</li>
<li>repset.fasta - a fasta file with the representative sequence of each ASV. Fasta headers are the ASV ID and taxonomy string.</li>
</ol>
<h3 id="5-summary-of-reads-throughout-pipeline">5. Summary of reads throughout pipeline</h3>
<p>Here we track the reads throughout the pipeline to see if any step is resulting in a greater-than-expected loss of reads. If a step is showing a greater than expected loss of reads, it is a good idea to go back to that step and troubleshoot why reads are dropping out. The dada2 tutorial has more details about what can be changed at each step.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>getN <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">getUniques</span>(x)) <span class="co"># function to grab sequence counts from output objects</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tracking reads by counts</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>filt_out_track <span class="ot">&lt;-</span> filt_out <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sample =</span> <span class="fu">gsub</span>(<span class="st">&quot;(R1</span><span class="sc">\\</span><span class="st">_)(.{1,})(</span><span class="sc">\\</span><span class="st">.fastq</span><span class="sc">\\</span><span class="st">.gz)&quot;</span>,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">2&quot;</span>,<span class="fu">rownames</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">input =</span> reads.in, <span class="at">filtered =</span> reads.out)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(filt_out_track) <span class="ot">&lt;-</span> filt_out_track<span class="sc">$</span>Sample</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>ddF_track <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">denoisedF =</span> <span class="fu">sapply</span>(ddF[sample.names], getN)) <span class="sc">%&gt;%</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sample =</span> <span class="fu">row.names</span>(.))</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>ddR_track <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">denoisedR =</span> <span class="fu">sapply</span>(ddR[sample.names], getN)) <span class="sc">%&gt;%</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sample =</span> <span class="fu">row.names</span>(.))</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>merge_track <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">merged =</span> <span class="fu">sapply</span>(mergers, getN)) <span class="sc">%&gt;%</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sample =</span> <span class="fu">row.names</span>(.))</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>chim_track <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">nonchim =</span> <span class="fu">rowSums</span>(seqtab.nochim)) <span class="sc">%&gt;%</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sample =</span> <span class="fu">row.names</span>(.))</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>track <span class="ot">&lt;-</span> <span class="fu">left_join</span>(filt_out_track, ddF_track, <span class="at">by =</span> <span class="st">&quot;Sample&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ddR_track, <span class="at">by =</span> <span class="st">&quot;Sample&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(merge_track, <span class="at">by =</span> <span class="st">&quot;Sample&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(chim_track, <span class="at">by =</span> <span class="st">&quot;Sample&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(., <span class="fu">is.na</span>(.), <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sample, <span class="fu">everything</span>())</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(track) <span class="ot">&lt;-</span> track<span class="sc">$</span>Sample</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(track)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="co"># tracking reads by percentage</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>track_pct <span class="ot">&lt;-</span> track <span class="sc">%&gt;%</span> </span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sample =</span> <span class="fu">rownames</span>(.),</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">filtered_pct =</span> <span class="fu">ifelse</span>(filtered <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">100</span> <span class="sc">*</span> (filtered<span class="sc">/</span>input)),</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">denoisedF_pct =</span> <span class="fu">ifelse</span>(denoisedF <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">100</span> <span class="sc">*</span> (denoisedF<span class="sc">/</span>filtered)),</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>         <span class="at">denoisedR_pct =</span> <span class="fu">ifelse</span>(denoisedR <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">100</span> <span class="sc">*</span> (denoisedR<span class="sc">/</span>filtered)),</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">merged_pct =</span> <span class="fu">ifelse</span>(merged <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">100</span> <span class="sc">*</span> merged<span class="sc">/</span>((denoisedF <span class="sc">+</span> denoisedR)<span class="sc">/</span><span class="dv">2</span>)),</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">nonchim_pct =</span> <span class="fu">ifelse</span>(nonchim <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">100</span> <span class="sc">*</span> (nonchim<span class="sc">/</span>merged)),</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>         <span class="at">total_pct =</span> <span class="fu">ifelse</span>(nonchim <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">100</span> <span class="sc">*</span> nonchim<span class="sc">/</span>input)) <span class="sc">%&gt;%</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sample, <span class="fu">ends_with</span>(<span class="st">&quot;_pct&quot;</span>))</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="co"># summary stats of tracked reads averaged across samples</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>track_pct_avg <span class="ot">&lt;-</span> track_pct <span class="sc">%&gt;%</span> <span class="fu">summarize_at</span>(<span class="fu">vars</span>(<span class="fu">ends_with</span>(<span class="st">&quot;_pct&quot;</span>)), </span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">list</span>(<span class="at">avg =</span> mean))</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(track_pct_avg)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>track_pct_med <span class="ot">&lt;-</span> track_pct <span class="sc">%&gt;%</span> <span class="fu">summarize_at</span>(<span class="fu">vars</span>(<span class="fu">ends_with</span>(<span class="st">&quot;_pct&quot;</span>)), </span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">list</span>(<span class="at">avg =</span> stats<span class="sc">::</span>median))</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(track_pct_avg)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(track_pct_med)</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting each sample&#39;s reads through the pipeline</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>track_plot <span class="ot">&lt;-</span> track <span class="sc">%&gt;%</span> </span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sample =</span> <span class="fu">rownames</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="at">key =</span> <span class="st">&quot;Step&quot;</span>, <span class="at">value =</span> <span class="st">&quot;Reads&quot;</span>, <span class="sc">-</span>Sample) <span class="sc">%&gt;%</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Step =</span> <span class="fu">factor</span>(Step, </span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;input&quot;</span>, <span class="st">&quot;filtered&quot;</span>, <span class="st">&quot;denoisedF&quot;</span>, <span class="st">&quot;denoisedR&quot;</span>, <span class="st">&quot;merged&quot;</span>, <span class="st">&quot;nonchim&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Step, <span class="at">y =</span> Reads)) <span class="sc">+</span></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> Sample), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun.y =</span> median, <span class="at">geom =</span> <span class="st">&quot;line&quot;</span>, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun.y =</span> median, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun.data =</span> median_hilow, <span class="at">fun.args =</span> <span class="fu">list</span>(<span class="at">conf.int =</span> <span class="fl">0.5</span>), </span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>               <span class="at">geom =</span> <span class="st">&quot;ribbon&quot;</span>, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="at">data =</span> <span class="fu">t</span>(track_pct_avg[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]) <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rename</span>(<span class="at">Percent =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mutate</span>(<span class="at">Step =</span> <span class="fu">c</span>(<span class="st">&quot;filtered&quot;</span>, <span class="st">&quot;denoisedF&quot;</span>, <span class="st">&quot;denoisedR&quot;</span>, <span class="st">&quot;merged&quot;</span>, <span class="st">&quot;nonchim&quot;</span>),</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Percent =</span> <span class="fu">paste</span>(<span class="fu">round</span>(Percent, <span class="dv">2</span>), <span class="st">&quot;%&quot;</span>)),</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">label =</span> Percent), <span class="at">y =</span> <span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(track[,<span class="dv">2</span>])) <span class="sc">+</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="at">data =</span> track_pct_avg[<span class="dv">6</span>] <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rename</span>(<span class="at">total =</span> <span class="dv">1</span>),</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste</span>(<span class="st">&quot;Total</span><span class="sc">\n</span><span class="st">Remaining:</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">round</span>(track_pct_avg[<span class="dv">1</span>,<span class="dv">6</span>], <span class="dv">2</span>), <span class="st">&quot;%&quot;</span>)), </span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> <span class="fu">mean</span>(track[,<span class="dv">6</span>]), <span class="at">x =</span> <span class="fl">6.5</span>) <span class="sc">+</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(track[,<span class="dv">2</span>]), <span class="at">x =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>track_plot</span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Write results to disk</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(track, <span class="fu">paste0</span>(project.fp, <span class="st">&quot;/tracking_reads.rds&quot;</span>))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(track_pct, <span class="fu">paste0</span>(project.fp, <span class="st">&quot;/tracking_reads_percentage.rds&quot;</span>))</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(track_plot, <span class="fu">paste0</span>(project.fp, <span class="st">&quot;/tracking_reads_summary_plot.rds&quot;</span>))</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> track_plot, <span class="at">filename =</span> <span class="fu">paste0</span>(project.fp, <span class="st">&quot;/tracking_reads_summary_plot.png&quot;</span>), <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="st">&quot;retina&quot;</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"><span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>STOP - 06_remove_chimeras_assign_taxonomy_dada2_tutorial_16S.R:</strong> If you are running this on Premise, make sure that you are using the appropriate database before running this step with slurm.</td>
</tr>
<tr class="even">
<td align="left"><span></td>
</tr>
</tbody>
</table>
<h2 id="next-steps">Next Steps</h2>
<p>You can now transfer over the output files onto your local computer. The table and taxonomy can be read into R with ‘mctoolsr’ package or another R package of your choosing.</p>
<h3 id="post-pipeline-considerations">Post-pipeline considerations</h3>
<p>After following this pipeline, you will need to think about the following in downstream applications:</p>
<ol style="list-style-type: decimal">
<li>Remove mitochondrial and chloroplast sequences</li>
<li>Remove reads assigned as eukaryotes</li>
<li>Remove reads that are unassigned at domain level (also consider removing those unassigned at phylum level)</li>
<li>Normalize or rarefy your ASV table</li>
</ol>
<p>Enjoy your data!</p>

</body>
</html>
